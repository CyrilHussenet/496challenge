<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>496 Challenge 2026 - Sync Fix</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/gpxparser@3.0.8/dist/GPXParser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        #map { height: 200px; border-radius: 1.5rem; }
        .medal-unlocked { background: linear-gradient(90deg, #ffd700, #fff5b1, #ffd700); background-size: 200%; animation: shine 3s linear infinite; }
        @keyframes shine { 0% { background-position: -200%; } 100% { background-position: 200%; } }
        .progress-bar-smooth { transition: width 1.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
        select { -webkit-appearance: none; appearance: none; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* TH√àME DYNAMIQUE */
        body { transition: background-color 1s ease, color 0.5s ease; }
        .dark-mode { background-color: #0a0a0a; color: white; }
        .dark-mode .card { background-color: #111827; border-color: #1f2937; }
        .dark-mode .text-muted { color: #9ca3af; }
        .light-mode { background-color: #f3f4f6; color: #111827; }
        .light-mode .card { background-color: #ffffff; border-color: #e5e7eb; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .light-mode .text-muted { color: #4b5563; }
        .light-mode nav { background-color: rgba(255, 255, 255, 0.8); border-color: #e5e7eb; }
    </style>
</head>
<body class="dark-mode font-sans selection:bg-lime-500 selection:text-black overflow-x-hidden">

    <div id="congrats-modal" class="fixed inset-0 z-[200] flex items-center justify-center bg-black/95 backdrop-blur-2xl hidden px-4 transition-all duration-700">
        <div class="bg-gray-900 border border-yellow-500/50 p-10 rounded-[3rem] w-full max-w-lg text-center shadow-[0_0_80px_rgba(234,179,8,0.2)]">
            <div class="text-7xl mb-6 animate-bounce">üèÜ</div>
            <h2 class="text-4xl font-black italic uppercase tracking-tighter text-yellow-500 mb-2">L√âGENDAIRE !</h2>
            <p class="text-white text-lg font-bold mb-4 uppercase tracking-widest">F√©licitations <span id="congrats-pseudo" class="text-lime-500">Champion</span></p>
            <p class="text-gray-400 text-xs mb-10 leading-relaxed uppercase tracking-widest">Tu as surv√©cu au Challenge 496.<br>Les 496 kilom√®tres sont officiellement vaincus.</p>
            <button onclick="closeCongrats()" class="bg-yellow-500 hover:bg-yellow-400 text-black font-black uppercase py-4 px-10 rounded-2xl shadow-xl transition-all active:scale-95">Fermer et Savourer</button>
        </div>
    </div>

    <div id="login-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/95 backdrop-blur-xl hidden px-4">
        <div class="card p-8 rounded-[2.5rem] border w-full max-w-md text-center shadow-2xl">
            <div class="w-16 h-16 bg-lime-500/10 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-user-shield text-lime-400 text-2xl"></i>
            </div>
            <h2 class="text-2xl font-black italic uppercase tracking-tighter mb-2">Identification</h2>
            <div class="space-y-4 text-left mt-6">
                <select id="modal-pseudo-select" class="w-full bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-2xl px-4 py-4 text-sm outline-none text-current cursor-pointer"></select>
                <input type="text" id="modal-new-pseudo" placeholder="Nouveau pseudo" class="w-full bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-2xl px-4 py-4 text-sm outline-none text-current">
                <button id="login-btn" onclick="confirmLogin()" class="w-full bg-lime-600 hover:bg-lime-500 text-black font-black uppercase py-4 rounded-2xl shadow-lg active:scale-95">Se connecter</button>
            </div>
        </div>
    </div>

    <div id="main-content">
        <nav class="p-4 backdrop-blur-md border-b sticky top-0 z-50 transition-colors duration-500">
            <div class="max-w-6xl mx-auto flex justify-between items-center">
                <h1 class="text-xl font-black text-lime-500 italic tracking-tighter uppercase">496 Social</h1>
                <div class="flex items-center gap-3 bg-gray-200 dark:bg-gray-800 px-3 py-1.5 rounded-full border border-gray-300 dark:border-gray-700">
                    <span id="current-user-name" class="text-[10px] font-black uppercase italic">Invit√©</span>
                    <button onclick="logout()" class="hover:text-red-500 transition-colors"><i class="fas fa-power-off text-xs"></i></button>
                </div>
            </div>
        </nav>

        <main class="max-w-6xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6 mt-4">
            <aside class="lg:col-span-3 order-2 lg:order-1">
                <div class="card p-5 rounded-[2rem] border shadow-xl sticky top-24 transition-all">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lime-500 font-black uppercase text-[10px] tracking-[0.2em] flex items-center gap-2"><i class="fas fa-trophy"></i> Classement</h3>
                        <span id="participant-count" class="bg-lime-500/10 text-lime-500 text-[9px] font-bold px-2 py-0.5 rounded-full border border-lime-500/20 uppercase tracking-tighter">0 Coureurs</span>
                    </div>
                    <div id="leaderboard" class="space-y-4"></div>
                </div>
            </aside>

            <div class="lg:col-span-6 order-1 lg:order-2 space-y-6">
                <div class="card p-8 rounded-[2.5rem] border shadow-2xl relative text-center md:text-left transition-all">
                    <div class="flex flex-col md:flex-row justify-between items-center md:items-end mb-4 gap-4">
                        <div>
                            <h2 class="text-6xl font-black italic tracking-tighter" id="total-display">0.0</h2>
                            <p class="text-muted font-bold uppercase text-[10px] tracking-widest mt-1">Km Cumul√©s / 496</p>
                        </div>
                        <span class="text-lime-400 font-black text-3xl" id="percent-display">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-800 h-4 rounded-full overflow-hidden mb-6">
                        <div id="progress-fill" class="progress-bar-smooth h-full bg-lime-500 w-0 shadow-[0_0_15px_rgba(132,204,22,0.4)]"></div>
                    </div>
                    <div class="flex justify-center">
                        <button onclick="shareProgress()" class="flex items-center gap-2 bg-[#25D366] hover:bg-[#20ba5a] text-white px-5 py-2 rounded-full text-[10px] font-black uppercase shadow-lg transition-transform active:scale-95">
                            <i class="fab fa-whatsapp text-lg"></i> Partager progr√®s
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex flex-col">
                        <button onclick="connectStrava()" class="bg-[#FC4C02] hover:bg-[#ff5712] p-6 rounded-[2rem] flex flex-col items-center justify-center transition-all group active:scale-95 shadow-lg h-full">
                            <svg class="w-8 h-8 mb-2 fill-white" viewBox="0 0 24 24"><path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066l-2.084 4.116zM10.257 7.833l-3.064 6.134h4.118l1.018-2.043 1.022 2.043h4.112l-7.206-14z"/></svg>
                            <span class="font-black uppercase text-[10px] tracking-widest text-white">Sync Strava</span>
                        </button>
                        <p id="last-sync-text" class="text-[9px] text-gray-600 mt-2 italic text-center uppercase tracking-tighter"></p>
                    </div>
                    <button onclick="document.getElementById('gpx-input').click()" class="card p-6 rounded-[2rem] border flex flex-col items-center justify-center transition-all border-gray-200 dark:border-gray-800 h-full"><i class="fas fa-route text-2xl text-lime-500 mb-2"></i><span class="font-black uppercase text-[10px] tracking-widest text-muted">Import GPX</span><input type="file" id="gpx-input" class="hidden" accept=".gpx" onchange="handleGPX(this)"></button>
                </div>

                <div class="card p-6 rounded-[2rem] border shadow-lg space-y-4 transition-all">
                    <h4 class="text-[9px] font-black uppercase text-muted tracking-[0.2em]">Saisie Manuelle</h4>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input type="date" id="manual-date" class="bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-xl px-3 py-2 text-xs outline-none flex-1 text-current">
                        <input type="number" id="manual-km" placeholder="Km" step="0.1" class="bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-xl px-3 py-2 text-xs outline-none w-full sm:w-24 text-current">
                        <button onclick="submitManualEntry()" class="bg-lime-500 hover:bg-lime-400 text-black font-black text-[10px] uppercase px-6 py-2 rounded-xl transition-all">Ajouter</button>
                    </div>
                </div>

                <div class="space-y-3" id="activities-list"></div>
            </div>

            <aside class="lg:col-span-3 order-3">
                <div id="medal-card" class="card group relative p-8 rounded-[2rem] border text-center flex flex-col items-center cursor-help transition-all duration-500">
                    <div class="relative w-28 h-28 mb-4 flex items-center justify-center">
                        <svg class="absolute top-0 left-0 w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="45" fill="none" stroke="#e5e7eb" stroke-width="6" class="dark:stroke-gray-800" />
                            <circle id="progress-ring" cx="50" cy="50" r="45" fill="none" stroke="#84cc16" stroke-width="6" stroke-linecap="round" stroke-dasharray="283" stroke-dashoffset="283" class="transition-all duration-1000" />
                        </svg>
                        <i id="medal-icon-svg" class="fas fa-medal text-4xl text-yellow-500 relative z-10" style="filter: grayscale(100%) brightness(30%);"></i>
                    </div>
                    <h3 class="font-black italic uppercase text-xs tracking-widest">Objectif 496</h3>
                    <p class="text-[10px] text-muted mt-2 uppercase" id="medal-status">0% Compl√©t√©</p>
                    <button onclick="deleteAccount()" class="mt-10 text-[8px] text-gray-600 hover:text-red-500 uppercase font-bold tracking-widest transition-colors">Supprimer Profil</button>
                </div>
            </aside>
        </main>
    </div>

    <script>
        const SUPABASE_URL = 'https://pbessdkzrifuadcarehx.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_GeLeELk8wOY5Q9t25Xx-wQ_C79jIfn5';
        const STRAVA_CLIENT_ID = '194165';
        const STRAVA_CLIENT_SECRET = '983b20e67b5f155aaa0bd4f733824cf89e32059d';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
        const REDIRECT_URI = window.location.origin + window.location.pathname;

        let myPseudo = localStorage.getItem('496_pseudo') || "";
        let userData = JSON.parse(localStorage.getItem('496_data_v11')) || { totalKm: 0, activities: [], ignoredIds: [], lastSync: null };

        // --- INITIALISATION ---
        window.addEventListener('DOMContentLoaded', async () => {
            applyTheme();
            await checkAuth();
            if(myPseudo) {
                document.getElementById('manual-date').valueAsDate = new Date();
                updateUI();
                refreshLeaderboard();
                checkStravaCallback();
                setInterval(updateSyncDisplay, 60000);
            }
        });

        function applyTheme() {
            const hour = new Date().getHours();
            if (hour >= 8 && hour < 18) document.body.classList.replace('dark-mode', 'light-mode');
            else document.body.classList.replace('light-mode', 'dark-mode');
        }

        async function checkAuth() {
            const modal = document.getElementById('login-modal');
            const main = document.getElementById('main-content');
            if (!myPseudo) {
                modal.classList.remove('hidden');
                main.classList.add('blur-bg');
                await populateModalPseudos();

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>496 Challenge 2026 - Secure Social</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/gpxparser@3.0.8/dist/GPXParser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        .medal-unlocked { background: linear-gradient(90deg, #ffd700, #fff5b1, #ffd700); background-size: 200%; animation: shine 3s linear infinite; }
        @keyframes shine { 0% { background-position: -200%; } 100% { background-position: 200%; } }
        .progress-bar-smooth { transition: width 1.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
        select { -webkit-appearance: none; appearance: none; }
        .blur-bg { filter: blur(15px); pointer-events: none; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-[#0a0a0a] text-white font-sans overflow-x-hidden">

    <div id="login-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/95 backdrop-blur-2xl hidden px-4">
        <div class="bg-gray-900 border border-gray-800 p-8 rounded-[2.5rem] w-full max-w-md shadow-2xl text-center">
            <h2 class="text-2xl font-black italic uppercase tracking-tighter mb-2">496 Social Club</h2>
            <p class="text-gray-500 text-[10px] mb-8 uppercase tracking-widest">Zone de s√©curit√© coureurs</p>
            
            <div class="space-y-4 text-left">
                <div class="space-y-2">
                    <label class="text-[9px] font-bold text-gray-500 uppercase ml-2">Profil existant</label>
                    <select id="modal-pseudo-select" class="w-full bg-gray-800 border border-gray-700 rounded-2xl px-4 py-4 text-sm text-white outline-none focus:border-lime-500 appearance-none cursor-pointer"></select>
                </div>

                <div class="relative py-2"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-800"></div></div><div class="relative flex justify-center text-[10px] uppercase text-gray-600 font-bold"><span class="bg-gray-900 px-2 uppercase">Ou cr√©er</span></div></div>

                <input type="text" id="modal-new-pseudo" placeholder="Nouveau pseudo" class="w-full bg-gray-800 border border-gray-700 rounded-2xl px-4 py-4 text-sm outline-none focus:border-lime-500 text-white">
                
                <div class="space-y-2">
                    <label class="text-[9px] font-bold text-lime-500 uppercase ml-2">Code PIN (4 chiffres)</label>
                    <input type="password" id="modal-pin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric" maxlength="4" class="w-full bg-gray-800 border-2 border-lime-500/20 rounded-2xl px-4 py-4 text-center text-2xl tracking-[1em] font-black outline-none focus:border-lime-500 text-lime-400">
                </div>

                <button id="login-btn" onclick="confirmLogin()" class="w-full bg-lime-600 hover:bg-lime-500 text-black font-black uppercase py-4 rounded-2xl shadow-lg active:scale-95 mt-4 transition-all">
                    Acc√©der au Dashboard
                </button>
            </div>
        </div>
    </div>

    <div id="main-content">
        <nav class="p-4 bg-gray-900/50 backdrop-blur-md border-b border-gray-800 sticky top-0 z-50">
            <div class="max-w-6xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 bg-lime-500 rounded-full animate-pulse"></div>
                    <h1 class="text-xl font-black text-white italic tracking-tighter uppercase">496 <span class="text-lime-400">SOCIAL</span></h1>
                </div>
                <div class="flex items-center gap-3 bg-gray-800 px-3 py-1.5 rounded-full border border-gray-700">
                    <img id="user-avatar" class="w-6 h-6 rounded-full hidden border border-gray-600 object-cover" src="" alt="">
                    <span id="current-user-name" class="text-[10px] font-black uppercase text-gray-300 italic">Invit√©</span>
                    <button onclick="logout()" class="text-gray-600 hover:text-red-500 ml-1 transition-colors"><i class="fas fa-power-off text-xs"></i></button>
                </div>
            </div>
        </nav>

        <main class="max-w-6xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6 mt-4">
            
            <aside class="lg:col-span-3 order-2 lg:order-1 space-y-6">
                <div class="bg-gray-900/40 p-5 rounded-[2rem] border border-gray-800 shadow-xl">
                    <h3 class="text-lime-400 font-black uppercase text-[10px] mb-4 tracking-[0.2em] flex items-center gap-2"><i class="fas fa-trophy"></i> Classement</h3>
                    <div id="leaderboard" class="space-y-4"></div>
                </div>

                <div class="bg-gray-900/40 p-5 rounded-[2rem] border border-gray-800 shadow-xl">
                    <h3 class="text-gray-400 font-black uppercase text-[10px] mb-4 tracking-[0.2em] flex items-center gap-2"><i class="fas fa-bolt text-lime-400"></i> Flux du Groupe</h3>
                    <div id="motivation-wall" class="space-y-4 text-[10px] text-gray-600 italic">...</div>
                </div>
            </aside>

            <div class="lg:col-span-6 order-1 lg:order-2 space-y-6">
                <div class="bg-gray-900 p-8 rounded-[2.5rem] border border-gray-800 shadow-2xl relative">
                    <div class="flex justify-between items-end mb-4">
                        <div><h2 class="text-6xl font-black italic tracking-tighter" id="total-display">0.0</h2><p class="text-gray-500 font-bold uppercase text-[10px] tracking-widest mt-1">Km / 496</p></div>
                        <span class="text-lime-400 font-black text-3xl" id="percent-display">0%</span>
                    </div>
                    <div class="w-full bg-gray-800 h-4 rounded-full overflow-hidden mb-6"><div id="progress-fill" class="progress-bar-smooth h-full bg-lime-500 w-0"></div></div>
                    <div class="flex justify-center">
                        <button onclick="shareProgress()" class="flex items-center gap-2 bg-[#25D366] px-5 py-2 rounded-full text-[10px] font-black uppercase shadow-lg active:scale-95 transition-all">
                            <i class="fab fa-whatsapp text-lg"></i> Partager sur WhatsApp
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex flex-col">
                        <button onclick="connectStrava()" class="bg-[#FC4C02] hover:bg-[#ff5712] p-6 rounded-[2rem] flex flex-col items-center h-full transition-all active:scale-95 shadow-lg">
                            <svg class="w-8 h-8 mb-2 fill-white" viewBox="0 0 24 24"><path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066l-2.084 4.116zM10.257 7.833l-3.064 6.134h4.118l1.018-2.043 1.022 2.043h4.112l-7.206-14z"/></svg>
                            <span class="font-black uppercase text-[10px] tracking-widest text-white">Sync Strava</span>
                        </button>
                        <p id="last-sync-text" class="text-[9px] text-gray-600 mt-2 text-center uppercase"></p>
                    </div>
                    <button onclick="document.getElementById('gpx-input').click()" class="bg-gray-800 hover:bg-gray-700 p-6 rounded-[2rem] flex flex-col items-center border border-gray-700 active:scale-95"><i class="fas fa-route text-2xl text-lime-400 mb-2"></i><span class="font-black uppercase text-[10px] tracking-widest text-gray-400">Import GPX</span><input type="file" id="gpx-input" class="hidden" accept=".gpx" onchange="handleGPX(this)"></button>
                </div>

                <div class="bg-gray-900/50 p-6 rounded-[2rem] border border-gray-800 shadow-lg space-y-4">
                    <h4 class="text-[9px] font-black uppercase text-gray-500 tracking-[0.2em]">Saisie Manuelle</h4>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input type="date" id="manual-date" class="bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-xs outline-none flex-1 text-white">
                        <input type="number" id="manual-km" placeholder="Km" step="0.1" class="bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-xs outline-none w-full sm:w-24 text-white">
                        <button onclick="submitManualEntry()" class="bg-white hover:bg-lime-500 text-black font-black text-[10px] uppercase px-6 py-2 rounded-xl transition-all">Ajouter</button>
                    </div>
                </div>

                <div class="space-y-3" id="activities-list"></div>
            </div>

            <aside class="lg:col-span-3 order-3">
                <div id="medal-card" class="bg-gray-900 p-8 rounded-[2rem] border border-gray-800 text-center flex flex-col items-center">
                    <div class="relative w-28 h-28 mb-4 flex items-center justify-center">
                        <svg class="absolute top-0 left-0 w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="45" fill="none" stroke="#1f2937" stroke-width="6" />
                            <circle id="progress-ring" cx="50" cy="50" r="45" fill="none" stroke="#84cc16" stroke-width="6" stroke-linecap="round" stroke-dasharray="283" stroke-dashoffset="283" class="transition-all duration-1000" />
                        </svg>
                        <i id="medal-icon-svg" class="fas fa-medal text-4xl text-yellow-500 relative z-10" style="filter: grayscale(100%) brightness(30%);"></i>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-2 uppercase font-black" id="medal-status">0% Compl√©t√©</p>
                    <button onclick="deleteAccount()" class="mt-10 text-[8px] text-gray-700 hover:text-red-500 font-bold uppercase tracking-widest">Supprimer Profil</button>
                </div>
            </aside>
        </main>
    </div>

    <script>
        const SUPABASE_URL = 'https://pbessdkzrifuadcarehx.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_GeLeELk8wOY5Q9t25Xx-wQ_C79jIfn5';
        const STRAVA_CLIENT_ID = '194165';
        const STRAVA_CLIENT_SECRET = '983b20e67b5f155aaa0bd4f733824cf89e32059d';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
        const REDIRECT_URI = window.location.origin + window.location.pathname;

        let myPseudo = localStorage.getItem('496_pseudo') || "";
        let userData = JSON.parse(localStorage.getItem('496_data_v11')) || { totalKm: 0, activities: [], lastSync: null, ignoredIds: [], avatarUrl: null };

        window.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            if(myPseudo) {
                document.getElementById('manual-date').valueAsDate = new Date();
                updateUI();
                refreshLeaderboard();
                checkStravaCallback();
                setInterval(updateSyncDisplay, 60000);
            }
        });

        // --- AUTH & LOGIN AVEC PIN ---
        async function checkAuth() {
            const modal = document.getElementById('login-modal');
            if (!myPseudo) {
                modal.classList.remove('hidden');
                document.getElementById('main-content').classList.add('blur-bg');
                await populateModalPseudos();
            } else {
                modal.classList.add('hidden');
                document.getElementById('main-content').classList.remove('blur-bg');
                document.getElementById('current-user-name').innerText = myPseudo;
                if(userData.avatarUrl) {
                    const img = document.getElementById('user-avatar');
                    img.src = userData.avatarUrl; img.classList.remove('hidden');
                }
            }
        }

        async function populateModalPseudos() {
            const { data } = await supabaseClient.from('scores').select('pseudo').order('pseudo');
            const select = document.getElementById('modal-pseudo-select');
            select.innerHTML = `<option value="">-- S√©lectionner mon profil --</option>`;
            if (data) data.forEach(u => select.add(new Option(u.pseudo, u.pseudo)));
        }

        async function confirmLogin() {
            const selected = document.getElementById('modal-pseudo-select').value;
            const created = document.getElementById('modal-new-pseudo').value.trim();
            const pin = document.getElementById('modal-pin').value.trim();
            const btn = document.getElementById('login-btn');

            if (pin.length !== 4) return alert("Le code PIN doit comporter 4 chiffres !");
            
            btn.innerText = "V√©rification...";
            btn.disabled = true;

            if (created) {
                // Cr√©ation : on v√©rifie d'abord si le pseudo existe
                const { data: exist } = await supabaseClient.from('scores').select('pseudo').eq('pseudo', created).single();
                if(exist) {
                    btn.innerText = "Acc√©der au Dashboard";
                    btn.disabled = false;
                    return alert("Ce pseudo existe d√©j√†, s√©lectionne-le dans la liste !");
                }
                myPseudo = created;
                await supabaseClient.from('scores').upsert({ 
                    pseudo: myPseudo, pin: pin, distance: 0, activities_data: [], ignored_ids: [], avatar_url: null 
                });
            } else if (selected) {
                // Connexion : on v√©rifie le PIN
                const { data, error } = await supabaseClient.from('scores').select('*').eq('pseudo', selected).single();
                if (data) {
                    if (data.pin !== pin) {
                        btn.innerText = "Acc√©der au Dashboard";
                        btn.disabled = false;
                        return alert("Code PIN incorrect !");
                    }
                    myPseudo = selected;
                    userData = { 
                        totalKm: parseFloat(data.distance) || 0, 
                        activities: data.activities_data || [], 
                        ignoredIds: data.ignored_ids || [], 
                        avatarUrl: data.avatar_url || null,
                        lastSync: userData.lastSync
                    };
                    localStorage.setItem('496_data_v11', JSON.stringify(userData));
                }
            } else { 
                btn.innerText = "Acc√©der au Dashboard";
                btn.disabled = false;
                return alert("Identifie-toi !"); 
            }

            localStorage.setItem('496_pseudo', myPseudo);
            location.reload();
        }

        async function syncWithCloud() {
            if(!myPseudo) return;
            // On ne renvoie pas le PIN ici pour ne pas risquer de l'√©craser malencontreusement
            await supabaseClient.from('scores').update({ 
                distance: userData.totalKm, 
                activities_data: userData.activities, 
                ignored_ids: userData.ignoredIds,
                avatar_url: userData.avatarUrl 
            }).eq('pseudo', myPseudo);
            refreshLeaderboard();
        }

        async function refreshLeaderboard() {
            const { data } = await supabaseClient.from('scores').select('*').order('distance', { ascending: false });
            if(data) {
                document.getElementById('leaderboard').innerHTML = data.map((u, i) => `
                    <div class="flex justify-between items-center ${u.pseudo === myPseudo ? 'bg-lime-900/10 p-2 rounded-xl border border-lime-500/20' : ''}">
                        <div class="flex items-center gap-2">
                            <span class="text-[9px] font-bold text-gray-700">${i+1}.</span>
                            ${u.avatar_url ? `<img src="${u.avatar_url}" class="w-6 h-6 rounded-full border border-gray-800 object-cover">` : `<div class="w-6 h-6 bg-gray-800 rounded-full flex items-center justify-center text-[8px] text-gray-500 font-bold uppercase">${u.pseudo[0]}</div>`}
                            <span class="text-xs font-bold ${u.pseudo === myPseudo ? 'text-lime-400' : 'text-gray-400'}">${u.pseudo}</span>
                        </div>
                        <span class="text-xs font-black text-white">${(parseFloat(u.distance) || 0).toFixed(1)} km</span>
                    </div>
                `).join('');

                let wallActs = [];
                data.forEach(user => {
                    (user.activities_data || []).forEach(a => wallActs.push({...a, user: user.pseudo, av: user.avatar_url}));
                });
                wallActs.sort((a, b) => new Date(b.dateISO) - new Date(a.dateISO));
                document.getElementById('motivation-wall').innerHTML = wallActs.slice(0, 5).map(a => `
                    <div class="flex items-center gap-2 border-l-2 border-lime-500/20 pl-2 animate-fade-in">
                        <img src="${a.av || 'https://via.placeholder.com/20'}" class="w-5 h-5 rounded-full object-cover">
                        <p class="text-[9px] text-gray-300"><span class="text-lime-400 font-bold">${a.user}</span> +${a.km}km</p>
                    </div>
                `).join('');
            }
        }

        function submitManualEntry() {
            const d = document.getElementById('manual-date').value;
            const k = parseFloat(document.getElementById('manual-km').value);
            if (!d || isNaN(k) || k <= 0) return alert("Saisie invalide");
            addActivity(k, "Entr√©e manuelle", null, d);
            document.getElementById('manual-km').value = "";
        }

        function addActivity(km, name, stravaId = null, dateOverride = null) {
            const dateISO = dateOverride ? new Date(dateOverride).toISOString() : new Date().toISOString();
            userData.activities.push({ 
                id: Date.now(), stravaId, km: parseFloat(km.toFixed(2)), name, dateISO,
                dateDisplay: new Date(dateISO).toLocaleDateString('fr-FR', {day:'numeric', month:'short'}) 
            });
            saveAndRefresh();
        }

        function saveAndRefresh() {
            userData.activities.sort((a, b) => new Date(b.dateISO) - new Date(a.dateISO));
            userData.totalKm = userData.activities.reduce((sum, a) => sum + a.km, 0);
            localStorage.setItem('496_data_v11', JSON.stringify(userData));
            updateUI();
            syncWithCloud();
        }

        function updateUI() {
            const total = userData.totalKm;
            const progress = Math.min(total / 496, 1);
            document.getElementById('total-display').innerText = total.toFixed(1);
            document.getElementById('progress-fill').style.width = (progress * 100) + "%";
            document.getElementById('percent-display').innerText = Math.round(progress * 100) + "%";
            document.getElementById('activities-list').innerHTML = userData.activities.map(a => `
                <div class="bg-gray-900/60 p-4 rounded-2xl border border-gray-800 flex justify-between items-center group animate-fade-in">
                    <div><p class="text-[9px] text-gray-500 uppercase font-bold">${a.dateDisplay}</p><p class="font-bold text-sm text-gray-300">${a.name}</p></div>
                    <div class="flex items-center gap-4"><span class="text-lime-400 font-black text-lg">+${a.km.toFixed(1)}</span>
                    <button onclick="deleteActivity(${a.id})" class="opacity-0 group-hover:opacity-100 text-gray-700 hover:text-red-500 p-2 transition-all"><i class="fas fa-trash"></i></button></div>
                </div>
            `).join('');
            document.getElementById('progress-ring').style.strokeDashoffset = 283 - (progress * 283);
            document.getElementById('medal-status').innerText = `${Math.round(progress * 100)}% Compl√©t√©`;
            updateSyncDisplay();
        }

        async function checkStravaCallback() {
            const code = new URLSearchParams(window.location.search).get('code');
            if (code) {
                try {
                    const tokenResp = await fetch('https://www.strava.com/oauth/token', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ client_id: STRAVA_CLIENT_ID, client_secret: STRAVA_CLIENT_SECRET, code, grant_type: 'authorization_code' })
                    });
                    const tokenData = await tokenResp.json();
                    if(tokenData.athlete) userData.avatarUrl = tokenData.athlete.profile_medium || tokenData.athlete.profile;
                    const actResp = await fetch(`https://www.strava.com/api/v3/athlete/activities?after=${Math.floor(new Date('2026-01-01').getTime()/1000)}`, {
                        headers: { 'Authorization': `Bearer ${tokenData.access_token}` }
                    });
                    const activities = await actResp.json();
                    activities.forEach(a => {
                        if((a.type === 'Run' || a.sport_type === 'Run') && !userData.activities.find(ex => ex.stravaId === a.id) && !userData.ignoredIds.includes(a.id)) {
                            addActivity(a.distance / 1000, a.name, a.id, a.start_date);
                        }
                    });
                    userData.lastSync = Date.now();
                    saveAndRefresh();
                    window.history.pushState({}, "", REDIRECT_URI);
                } catch(e) { console.error(e); }
            }
        }

        function deleteActivity(id) {
            const act = userData.activities.find(a => a.id === id);
            if(confirm("Supprimer cette activit√© ?")) {
                if (act.stravaId) userData.ignoredIds.push(act.stravaId);
                userData.activities = userData.activities.filter(a => a.id !== id);
                saveAndRefresh();
            }
        }

        function shareProgress() {
            const msg = `üèÉ‚Äç‚ôÇÔ∏è *${myPseudo}* : *${userData.totalKm.toFixed(1)} km* sur le 496 ! üìä *${Math.round((userData.totalKm/496)*100)}%*`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function updateSyncDisplay() {
            if(!userData.lastSync) return;
            const diff = Math.floor((Date.now() - userData.lastSync) / 60000);
            document.getElementById('last-sync-text').innerText = diff < 1 ? "Sync. √† l'instant" : `Sync. il y a ${diff} min`;
        }

        function handleGPX(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const gpx = new gpxParser(); gpx.parse(e.target.result);
                addActivity(gpx.tracks[0].distance.total / 1000, "Import GPX");
            };
            reader.readAsText(input.files[0]);
        }

        function logout() { 
            if(confirm("Te d√©connecter ? Ton profil est prot√©g√© par ton code PIN.")) {
                localStorage.removeItem('496_pseudo'); 
                location.reload(); 
            }
        }
        
        async function deleteAccount() {
            if(confirm("Supprimer d√©finitivement ce profil ? Cette action est irr√©versible.")) {
                const pin = prompt("Confirme ton code PIN pour supprimer :");
                const { data } = await supabaseClient.from('scores').select('pin').eq('pseudo', myPseudo).single();
                if(data && data.pin === pin) {
                    await supabaseClient.from('scores').delete().eq('pseudo', myPseudo);
                    localStorage.clear(); 
                    location.reload();
                } else {
                    alert("Code PIN incorrect !");
                }
            }
        }

        function connectStrava() { window.location.href = `https://www.strava.com/oauth/authorize?client_id=${STRAVA_CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=code&scope=activity:read_all`; }
    </script>
</body>
</html>

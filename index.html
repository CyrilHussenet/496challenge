<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>496 Challenge 2026 - Group Live</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/gpxparser@3.0.8/dist/GPXParser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        #map { height: 200px; border-radius: 1.5rem; }
        .medal-unlocked { 
            background: linear-gradient(90deg, #ffd700, #fff5b1, #ffd700); 
            background-size: 200%; 
            animation: shine 3s linear infinite; 
        }
        @keyframes shine { 0% { background-position: -200%; } 100% { background-position: 200%; } }
        .progress-bar-smooth { transition: width 1.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
    </style>
</head>
<body class="bg-[#0a0a0a] text-white font-sans selection:bg-lime-500 selection:text-black">

    <nav class="p-4 bg-gray-900/50 backdrop-blur-md border-b border-gray-800 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-black text-lime-400 italic tracking-tighter">496 CHALLENGE 2026</h1>
            <div class="flex gap-2">
                <input type="text" id="pseudo" placeholder="Pseudo" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-1 text-sm outline-none focus:border-lime-500 w-32 text-white">
                <button onclick="savePseudo()" class="bg-lime-600 hover:bg-lime-500 text-black font-bold text-xs px-3 rounded-lg transition-colors">OK</button>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6 mt-4">
        
        <aside class="lg:col-span-3 order-2 lg:order-1">
            <div class="bg-gray-900/40 p-5 rounded-[2rem] border border-gray-800 shadow-xl">
                <h3 class="text-lime-400 font-black uppercase text-[10px] mb-4 tracking-[0.2em] flex items-center gap-2">
                    <i class="fas fa-trophy"></i> Leaderboard Groupe
                </h3>
                <div id="leaderboard" class="space-y-4">
                    <p class="text-gray-600 text-xs animate-pulse italic text-center py-4">Connexion √† Supabase...</p>
                </div>
                <div class="mt-6 pt-4 border-t border-gray-800">
                    <button onclick="deleteMyAccount()" class="text-[9px] text-gray-600 hover:text-red-500 uppercase font-bold tracking-widest transition-colors">
                        <i class="fas fa-user-slash mr-1"></i> Quitter le challenge
                    </button>
                </div>
            </div>
        </aside>

        <div class="lg:col-span-6 order-1 lg:order-2 space-y-6">
            
            <div class="flex justify-center">
                <div class="bg-gray-900/80 px-6 py-2 rounded-full border border-gray-800 flex items-center gap-3">
                    <i class="fas fa-hourglass-half text-lime-400 animate-pulse text-xs"></i>
                    <span id="countdown-text" class="text-[10px] font-black uppercase tracking-widest text-gray-300">Calcul du temps restant...</span>
                </div>
            </div>

            <div class="bg-gray-900 p-8 rounded-[2.5rem] border border-gray-800 shadow-2xl relative overflow-hidden">
                <div class="flex justify-between items-end mb-4 relative z-10">
                    <div>
                        <h2 class="text-6xl font-black italic tracking-tighter" id="total-display">0.0</h2>
                        <p class="text-gray-500 font-bold uppercase text-[10px] tracking-widest mt-1">Kilom√®tres cumul√©s / 496</p>
                    </div>
                    <span class="text-lime-400 font-black text-3xl" id="percent-display">0%</span>
                </div>
                <div class="w-full bg-gray-800 h-4 rounded-full overflow-hidden relative z-10">
                    <div id="progress-fill" class="progress-bar-smooth h-full bg-lime-500 w-0"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="connectStrava()" class="bg-[#FC4C02] hover:bg-[#ff5712] p-6 rounded-[2rem] flex flex-col items-center justify-center transition-all group active:scale-95 shadow-lg shadow-orange-950/20">
                    <svg class="w-8 h-8 mb-2 fill-white" viewBox="0 0 24 24"><path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066l-2.084 4.116zM10.257 7.833l-3.064 6.134h4.118l1.018-2.043 1.022 2.043h4.112l-7.206-14z"/></svg>
                    <span class="font-black uppercase text-[10px] tracking-widest text-white">Sync Strava</span>
                </button>
                <button onclick="document.getElementById('gpx-input').click()" class="bg-gray-800 hover:bg-gray-700 p-6 rounded-[2rem] flex flex-col items-center justify-center transition-all border border-gray-700 active:scale-95">
                    <i class="fas fa-file-upload text-2xl text-lime-400 mb-2"></i>
                    <span class="font-black uppercase text-[10px] tracking-widest text-gray-400">Importer GPX</span>
                    <input type="file" id="gpx-input" class="hidden" accept=".gpx" onchange="handleGPX(this)">
                </button>
            </div>

            <div class="bg-gray-900/50 p-6 rounded-[2rem] border border-gray-800 shadow-lg space-y-4">
                <h4 class="text-[9px] font-black uppercase text-gray-500 tracking-[0.2em]">Ajout Manuel</h4>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="date" id="manual-date" class="bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-xs outline-none focus:border-lime-500 flex-1 text-white">
                    <input type="number" id="manual-km" placeholder="Km" step="0.1" class="bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-xs outline-none focus:border-lime-500 w-full sm:w-24 text-white">
                    <button onclick="submitManualEntry()" class="bg-white hover:bg-lime-500 text-black font-black text-[10px] uppercase px-6 py-2 rounded-xl transition-all active:scale-95">Ajouter</button>
                </div>
            </div>

            <div id="map-container" class="hidden bg-gray-900 p-2 rounded-[2rem] border border-gray-800 shadow-lg overflow-hidden">
                <div id="map"></div>
            </div>

            <div class="space-y-3" id="activities-list"></div>
        </div>

        <aside class="lg:col-span-3 order-3">
            <div id="medal-card" class="group relative bg-gray-900 p-8 rounded-[2rem] border border-gray-800 text-center transition-all duration-500 flex flex-col items-center cursor-help">
                
                <div class="absolute -top-12 left-1/2 -translate-x-1/2 bg-lime-500 text-black text-[10px] font-black px-3 py-2 rounded-xl opacity-0 group-hover:opacity-100 transition-all duration-300 pointer-events-none whitespace-nowrap z-50 transform translate-y-2 group-hover:translate-y-0">
                    <span id="medal-tooltip">Calcul...</span>
                    <div class="absolute top-full left-1/2 -translate-x-1/2 border-[6px] border-transparent border-t-lime-500"></div>
                </div>

                <div id="medal-container" class="w-24 h-24 bg-gray-800 rounded-full mb-4 flex items-center justify-center border-4 border-gray-700 transition-all duration-500">
                    <i id="medal-icon-svg" class="fas fa-medal text-4xl text-yellow-500 transition-all duration-500" style="filter: grayscale(100%) brightness(30%);"></i>
                </div>
                
                <h3 class="font-black italic uppercase text-xs tracking-widest">496 Finisher</h3>
                <p class="text-[10px] text-gray-500 mt-2 uppercase" id="medal-status">0% compl√©t√©</p>
            </div>
        </aside>
    </main>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://pbessdkzrifuadcarehx.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_GeLeELk8wOY5Q9t25Xx-wQ_C79jIfn5';
        const STRAVA_CLIENT_ID = '194165';
        const STRAVA_CLIENT_SECRET = '983b20e67b5f155aaa0bd4f733824cf89e32059d';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
        const REDIRECT_URI = window.location.origin + window.location.pathname;

        let myPseudo = localStorage.getItem('496_pseudo') || "";
        let userData = JSON.parse(localStorage.getItem('496_data')) || { totalKm: 0, activities: [] };
        let map = null, polyline = null;

        // Initialisation
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('pseudo').value = myPseudo;
            document.getElementById('manual-date').valueAsDate = new Date();
            updateUI();
            updateCountdown();
            refreshLeaderboard();
            checkStravaCallback();
        });

        // --- COMPTE √Ä REBOURS ---
        function updateCountdown() {
            const end = new Date(2026, 0, 31, 23, 59, 59);
            const now = new Date();
            const diff = end - now;
            const display = document.getElementById('countdown-text');
            if (diff > 0) {
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                display.innerText = `${days} jours et ${hours}h restants en janvier`;
            } else { display.innerText = "Challenge Termin√© !"; }
        }

        // --- GESTION UTILISATEUR & CLOUD ---
        function savePseudo() {
            const input = document.getElementById('pseudo').value.trim();
            if(input) {
                myPseudo = input;
                localStorage.setItem('496_pseudo', myPseudo);
                syncWithCloud();
            } else { alert("Entre un pseudo valide !"); }
        }

        async function syncWithCloud() {
            if(!myPseudo) return;
            try {
                await supabaseClient.from('scores').upsert({ pseudo: myPseudo, distance: userData.totalKm });
                refreshLeaderboard();
            } catch (err) { console.error("Erreur Synchro Cloud", err); }
        }

        async function refreshLeaderboard() {
            try {
                const { data } = await supabaseClient.from('scores').select('*').order('distance', { ascending: false });
                if(data) {
                    document.getElementById('leaderboard').innerHTML = data.map((u, i) => `
                        <div class="flex justify-between items-center ${u.pseudo === myPseudo ? 'bg-lime-900/10 p-2 rounded-xl border border-lime-500/20' : ''}">
                            <div class="flex items-center gap-3">
                                <span class="text-[10px] font-bold text-gray-600">${i+1}.</span>
                                <span class="text-xs font-bold ${u.pseudo === myPseudo ? 'text-lime-400' : 'text-gray-300'}">${u.pseudo}</span>
                            </div>
                            <span class="text-xs font-black">${u.distance.toFixed(1)} km</span>
                        </div>
                    `).join('');
                }
            } catch (err) { console.error("Erreur Leaderboard", err); }
        }

        async function deleteMyAccount() {
            if (!myPseudo) return;
            if (confirm(`Supprimer d√©finitivement le pseudo "${myPseudo}" ?`)) {
                await supabaseClient.from('scores').delete().eq('pseudo', myPseudo);
                localStorage.clear();
                window.location.reload();
            }
        }

        // --- AJOUT D'ACTIVIT√âS ---
        function submitManualEntry() {
            if(!myPseudo) return alert("Choisis un pseudo !");
            const dateVal = document.getElementById('manual-date').value;
            const kmVal = parseFloat(document.getElementById('manual-km').value);
            if (!dateVal || isNaN(kmVal) || kmVal <= 0) return alert("Saisie invalide.");

            const dateObj = new Date(dateVal);
            const formatted = dateObj.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
            addActivity(kmVal, "Saisie manuelle", null, formatted);
            document.getElementById('manual-km').value = "";
        }

        function handleGPX(input) {
            if(!myPseudo) return alert("Choisis un pseudo !");
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const gpx = new gpxParser();
                gpx.parse(e.target.result);
                const dist = gpx.tracks[0].distance.total / 1000;
                addActivity(dist, file.name);
                drawMap(gpx.tracks[0].points.map(p => [p.lat, p.lon]));
            };
            reader.readAsText(file);
        }

        async function connectStrava() {
            if(!myPseudo) return alert("Pseudo requis !");
            window.location.href = `https://www.strava.com/oauth/authorize?client_id=${STRAVA_CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=code&scope=activity:read_all`;
        }

        async function checkStravaCallback() {
    const code = new URLSearchParams(window.location.search).get('code');
    if (code) {
        try {
            const tokenResp = await fetch('https://www.strava.com/oauth/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    client_id: STRAVA_CLIENT_ID, 
                    client_secret: STRAVA_CLIENT_SECRET, 
                    code: code, 
                    grant_type: 'authorization_code' 
                })
            });
            const tokenData = await tokenResp.json();
            
            const afterDate = Math.floor(new Date('2026-01-01').getTime() / 1000);
            const actResp = await fetch(`https://www.strava.com/api/v3/athlete/activities?after=${afterDate}`, {
                headers: { 'Authorization': `Bearer ${tokenData.access_token}` }
            });
            const activities = await actResp.json();

            activities.forEach(a => {
                // On v√©rifie si c'est une course et si elle n'est pas d√©j√† enregistr√©e
                if((a.type === 'Run' || a.sport_type === 'Run') && !userData.activities.find(ex => ex.stravaId === a.id)) {
                    
                    // --- EXTRACTION ET FORMATAGE DE LA DATE STRAVA ---
                    const stravaDate = new Date(a.start_date); 
                    const formattedDate = stravaDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
                    
                    // On passe formattedDate en 4√®me argument
                    addActivity(a.distance / 1000, a.name, a.id, formattedDate);
                }
            });
            
            // Nettoyage de l'URL pour enlever le code Strava
            window.history.pushState({}, document.title, REDIRECT_URI);
            
        } catch(e) { 
            console.error("Erreur Strava", e); 
            alert("Erreur lors de la r√©cup√©ration des dates Strava.");
        }
    }
}
            }
        }

        function addActivity(km, name, stravaId = null, dateOverride = null) {
            const date = dateOverride || new Date().toLocaleDateString('fr-FR', {day:'numeric', month:'short'});
            const act = { id: Date.now(), stravaId, km: parseFloat(km.toFixed(2)), name, date };
            userData.activities.unshift(act);
            saveAndRefresh();
        }

        function deleteActivity(id) {
            if(confirm("Supprimer cette activit√© ?")) {
                userData.activities = userData.activities.filter(a => a.id !== id);
                saveAndRefresh();
            }
        }

        function saveAndRefresh() {
            userData.totalKm = userData.activities.reduce((sum, a) => sum + a.km, 0);
            localStorage.setItem('496_data', JSON.stringify(userData));
            updateUI();
            syncWithCloud();
        }

        // --- INTERFACE ---
        function updateUI() {
            const total = userData.totalKm;
            const progress = Math.min(total / 496, 1);
            const remaining = Math.max(0, 496 - total);

            document.getElementById('total-display').innerText = total.toFixed(1);
            document.getElementById('progress-fill').style.width = (progress * 100) + "%";
            document.getElementById('percent-display').innerText = Math.round(progress * 100) + "%";

            // Historique
            document.getElementById('activities-list').innerHTML = userData.activities.map(a => `
                <div class="bg-gray-900/60 p-4 rounded-2xl border border-gray-800 flex justify-between items-center group">
                    <div>
                        <p class="text-[10px] text-gray-500 font-bold uppercase">${a.date}</p>
                        <p class="font-bold text-sm truncate w-40">${a.name}</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="text-lime-400 font-black text-lg">+${a.km}</span>
                        <button onclick="deleteActivity(${a.id})" class="opacity-0 group-hover:opacity-100 text-gray-600 hover:text-red-500 transition-all p-2"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');

            // M√©daille & Tooltip
            const icon = document.getElementById('medal-icon-svg');
            const container = document.getElementById('medal-container');
            const tooltip = document.getElementById('medal-tooltip');
            
            const gray = 100 - (progress * 100);
            const bright = 30 + (progress * 70);
            const glow = progress * 20;

            icon.style.filter = `grayscale(${gray}%) brightness(${bright}%)`;
            container.style.borderColor = `rgba(132, 204, 22, ${progress})`;
            container.style.boxShadow = `0 0 ${glow}px rgba(132, 204, 22, ${progress * 0.5})`;

            if (total >= 496) {
                document.getElementById('medal-card').classList.add('medal-unlocked');
                tooltip.innerText = "CHALLENGE R√âUSSI ! üèÜ";
                tooltip.classList.replace('bg-lime-500', 'bg-yellow-400');
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors:['#84cc16','#ffd700','#ffffff'] });
            } else {
                tooltip.innerText = `ENCORE ${remaining.toFixed(1)} KM !`;
            }
            document.getElementById('medal-status').innerText = `${Math.round(progress * 100)}% compl√©t√©`;
        }

        function drawMap(points) {
            document.getElementById('map-container').classList.remove('hidden');
            if(!map) {
                map = L.map('map', {zoomControl: false}).setView(points[0], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            }
            if(polyline) map.removeLayer(polyline);
            polyline = L.polyline(points, {color: '#84cc16', weight: 4, opacity: 0.8}).addTo(map);
            map.fitBounds(polyline.getBounds());
        }
    </script>
</body>
</html>
